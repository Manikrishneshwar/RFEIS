from pydantic import BaseModel, Field
from typing import Literal
import requests
import os

class FinancialEventClassification(BaseModel):
    event_type: str = Field(description="Type of financial event.")
    impact_direction: Literal["POSITIVE", "NEGATIVE", "NEUTRAL"]
    confidence: float = Field(ge=0, le=1)
    explanation: str

def build_prompt(title, source):
    return f"""
You are a financial analyst.

Return ONLY valid JSON. No text outside JSON.

Format:
{{
  "event_type": "...",
  "impact_direction": "POSITIVE|NEGATIVE|NEUTRAL",
  "confidence": 0.0-1.0,
  "explanation": "..."
}}

Headline: {title}
Source: {source}
"""

GROQ_API_KEY = "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" 
GROQ_API_URL = "https://api.groq.ai/v1/engines/text-generation/completions"

HEADERS = {
    "Authorization": f"Bearer {GROQ_API_KEY}",
    "Content-Type": "application/json"
}

def process_event(event):
    """
    Input: Deduplicated financial news event
    Output: FinancialEventClassification instance
    """
    prompt = build_prompt(event["title"], event["source"])
    
    payload = {
        "prompt": prompt,
        "max_output_tokens": 256,
        "temperature": 0.0
    }

    response = requests.post(GROQ_API_URL, headers=HEADERS, json=payload)
    response.raise_for_status()
    groq_output = response.json()["completions"][0]["content"].strip()

    import json
    try:
        parsed = json.loads(groq_output)
        return FinancialEventClassification(
            event_type=parsed.get("event_type", "MACRO_NEWS"),
            impact_direction=parsed.get("impact_direction", "NEUTRAL"),
            confidence=float(parsed.get("confidence", 0.6)),
            explanation=parsed.get("explanation", "Generated by Groq API")
        )
    except (json.JSONDecodeError, TypeError):
        return FinancialEventClassification(
            event_type="MACRO_NEWS",
            impact_direction="NEUTRAL",
            confidence=0.6,
            explanation="Failed to parse Groq output; fallback applied"
        )
